version: "3.9"

services:
  chrome:
    image: selenium/standalone-chrome:latest
    container_name: chrome
    shm_size: 2g
    ports:
      - "4444:4444"   # Selenium Grid port
      - "5900:5900"   # VNC for debugging
      - "9222:9222"   # CDP port for attaching playwright MCP server
      - "${MCP_PORT:-3000}:${MCP_PORT:-3000}"   # MCP HTTP transport (shared network with mcp)
    environment:
      - SE_START_XVFB=true
      - SE_NODE_MAX_SESSIONS=1
      - SE_NODE_SESSION_TIMEOUT=3600
      - SE_NODE_STEREOTYPE={"browserName":"chrome","goog:chromeOptions":{"args":["--remote-debugging-port=9222","--user-data-dir=/home/seluser/chrome-profile","--disable-blink-features=AutomationControlled","--disable-dev-shm-usage","--no-default-browser-check","--no-first-run","--disable-infobars","--window-size=1920,1080"],"prefs":{"credentials_enable_service":false}}}
      - VNC_NO_PASSWORD=1
      - DISPLAY=:99
      - SCREEN_WIDTH=1920
      - SCREEN_HEIGHT=1080
      - SCREEN_DEPTH=24
    volumes:
      - chrome-profile:/home/seluser/chrome-profile
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/status"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  bootstrap:
    image: node:20-slim
    container_name: chrome-bootstrap
    working_dir: /work
    volumes:
      - ./bootstrap-session.js:/work/bootstrap-session.js:ro
    environment:
      - SELENIUM_BASE=http://chrome:4444
      - KEEPALIVE_INTERVAL_MS=60000
    depends_on:
      chrome:
        condition: service_healthy
    restart: unless-stopped
    command: ["node", "/work/bootstrap-session.js"]

  mcp:
    image: mcp/playwright:latest
    container_name: mcp-playwright
    network_mode: service:chrome
    depends_on:
      chrome:
        condition: service_healthy
      bootstrap:
        condition: service_started
    command:
      [
        "--port", "${MCP_PORT:-3000}",
        "--host", "0.0.0.0",
        "--allowed-hosts", "*",
        # localhost and "shared network" mode with selenium service because selenium only allows localhost to connect to its cdp (9222) endpoint
        "--cdp-endpoint", "http://localhost:9222"
      ]
    restart: unless-stopped

volumes:
  chrome-profile:
